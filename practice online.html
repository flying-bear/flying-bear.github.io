<!doctype html>
<!-- 
TO DO
	add moving between pages
	check instruction
	check fileText
	check training (to verify that they got the instruction right) 
	upload data from somewhere: src <script> var fileSrcArray = ["1_1_мошенник.wav", "1_2_мажор.wav"]; /* массив адресов файлов, стоит брать его из наружного файла */</script>
	download data somewhere: 
		<script>
			var blob = new Blob([JSON.stringify([0,1,2])], {type : 'application/json'});
			var fileOfBlob = new File([blob], 'aFileName.json');
			form.append("upload", fileOfBlob);
		</script>
		<script>
		  var client = filestack.init('A7iAeWAkkSZ67VSjAJPuZz', { policy: 'policy', signature: 'gmryazanskaya' });
		  client.upload(file);
		</script>
	add design
-->

<html lang="en, ru">
<head>
	<meta charset="utf-8">

	<title>Experiment</title>
	<meta name="description" content="Исследование скорости узнавания предъявляемых на слух слов">
	<meta name="author" content="V">
  
	<!--link rel="stylesheet" href="css/styles.css?v=1.0"-->

	<!--[if lt IE 9]>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
	<![endif]-->
	<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	<script type="text/javascript" src="https://static.filestackapi.com/v3/filestack.js"></script>
  
	<script>
		var fileSrcArray = ["1_1_мошенник.wav", "1_2_мажор.wav"]; /* массив адресов файлов, стоит брать его из наружного файла */
	</script>
	
	<script>
		var fileTrainingSrcArray = ["1_1_мошенник.wav", "1_2_мажор.wav"]; /* массив адресов файлов, стоит брать его из наружного файла */
	</script>
  
	<script>
"use strict"
		var currentLength = 0.250; /* до какого момента пригрывать запись - изначально 250ms */
		var inputArray = []; /* сюда складываются массивы ответов и данных о них */
		var firstRun = true; /* первое ли слово проигрывается */
		var audioFinished = false; /* проиграно ли слово до конца */
		var wordsSolvedCounter = 0; /* количество решённых слов */
		var audio;
		var rightAnswer; /* правильный ответ */
		var usersInput; /* username испытуемого */
		var userData; /* анкетные данные испытуемого */
		var fileText = ""; /* текст файла с результатами */
		var attempts = 0; /* число тренировочных попыток угадать слово */
		var training = true;


		$(function(){
			audio = document.getElementById('sample'); /* текущее слово (аудио) */
			function createAndUploadCSVFile(text, name) {
				var blob = new Blob([text], {type : 'text/csv'});
				var client = filestack.init('A7iAeWAkkSZ67VSjAJPuZz', { policy: 'policy', signature: 'gmryazanskaya' });
				client.upload(blob, {}, {filename: name});
			}
			
			function getToTheNextWord(){ /* перейти к следующему слову */
				if (training == false){ /* экспериментальные задания */
					if (wordsSolvedCounter < fileSrcArray.length){ /* если решено слов меньше длины списка слов */
						wordsSolvedCounter += 1; /* прибавить 1 к числу решённых слов */
						currentLength = 0.250 /* сбросить текущую длину проигрывания до начальной */
						document.getElementById('sample').src = fileSrcArray[wordsSolvedCounter - 1]; /* положить в переменную audio следующий файл из спика адресов файлов */
						var source = decodeURI(document.getElementById('sample').src); /* обновить правильный ответ: адрес файла кладётся в текстовую переменную */
						rightAnswer = source.match( /_\d+_(.*)\./i )[1].toLowerCase(); /* положить эту текстовую переменную в правильный ответ */
					} else { /* если решено слов столько же или больше длины списка слов */
						document.getElementById('wordInputDiv').style="display: none"; /* скрыть инпут слов */
						$("#wordInputDiv").hide();
						$('#text').html("Эксперимент окончен, спасибо за участие! Пожалуйста, не рассказывайте никому о содержании эксперимента до его завершения."); /* изменить текст */
						$('#playButton').hide(); /* скрыть кнопку Play */
						var i, j, textLine
						for (i = 0; i < inputArray.length; i++) { /* создать текст из InputArray */
							for (j = 0; j < inputArray[i].length; j++){
								textLine = inputArray[i].join(";");
							};
							fileText += textLine + "\n";
						};
						var userDataCsv=""; $.each(userData, function(k,v) {userDataCsv+=k+":"+v+"; \n";});
						createAndUploadCSVFile(fileText, userData.userName+" answers.csv");
						createAndUploadCSVFile(userDataCsv, userData.userName+" user data.csv");
					};
				} else { /* тренировочные задания */
					if (wordsSolvedCounter < fileTrainingSrcArray.length){ /* если решено слов меньше длины списка слов */
						wordsSolvedCounter += 1; /* прибавить 1 к числу решённых слов */
						currentLength = 0.250; /* сбросить текущую длину проигрывания до начальной */
						document.getElementById('sample').src = fileTrainingSrcArray[wordsSolvedCounter - 1]; /* положить в переменную audio следующий файл из спика адресов файлов */
						var source = decodeURI(document.getElementById('sample').src); /* обновить правильный ответ: адрес файла кладётся в текстовую переменную */
						rightAnswer = source.match( /_\d+_(.*)\./i )[1].toLowerCase(); /* положить эту текстовую переменную в правильный ответ */
					} else { /* если решено слов столько же или больше длины списка слов */
						$('#trainingPage').hide(); /* скрыть trainingPage */
						document.getElementById('consentPage').style="display: block"; /* скрыть кнопку Play */
						training = false;
						wordsSolvedCounter = 0; /* сбросить число решённых слов */
					};
				
				};
			};
			
			
			$("#verbForm").on("submit", function() { /* обработать введённое пользователем слово */
				if (event.preventDefault) event.preventDefault(); /* не переходить на новую страницу (отключить обработчик по умолчанию) */
				var currentInput = document.getElementById('input').value.toLowerCase(); /* положить в переменную текущий инпут */ 
				console.log(inputArray)
				if (currentInput == rightAnswer) { /* если верный ответ */
					inputArray.push([userData.userName, rightAnswer, currentLength, currentInput, "true"]); /* сложить значения в массив ответов */
					document.getElementById('text').innerText = "Вы ввели верное слово. Для проигрывания следующего слова нажмите на Play."; /* изменить текст */
					getToTheNextWord() /* перейти к следующему слову */
				}
				else{ /* если неверный ответ */
					inputArray.push([userData.userName, rightAnswer, currentLength, currentInput, "false"]); /* сложить значения в массив ответов */
					if (audioFinished == false){ /* если слово не проиграно до конца */
						currentLength += 0.050; /* прибавить 50ms */
						document.getElementById('text').innerText = "Вы ввели неверное слово. Для повторного проигрывания слова нажмите на Play."; /* изменить текст */
					};
				};
				document.getElementById('input').value = "" /* стереть значение инпута */
				$("#playButton").click();
				return false;
			});



			setInterval(function () { /* остановить аудио по нужному времени */
				if (currentLength && audio.currentTime >= currentLength) { /* если есть максимальная длина и она меньше текущей длины */
					audio.pause(); /* остановить аудио */
				};
			}, 30); /* проверять условие каждые 30ms */

			
			$("#playButton").on("click", function(){
				if (event.preventDefault) event.preventDefault(); /* не переходить на новую страницу (отключить обработчик по умолчанию) */
				audio.currentTime = 0.0; /* начать проигрываеть слово с начала */
				audio.play(); /* проиграть слово */
				if(firstRun == true){ /* если проигрывается первое слово */
					document.getElementById('text').innerText = "Введите слово. Если вы не знаете слова, нажмите на Play." /* изменить текст */
				};
				firstRun = false; /* изменить значение на "проигрывается не первое слово" */
				audio.addEventListener("ended", function(){ /* когда аудио заканчивается */
					audioFinished = true; /* аудио закончилось */
					console.log('finished');
					document.getElementById('text').innerText = "Слово проиграно до конца. Нажмите на Play для проигрывания следуюущего слова." /* изменить текст */
					getToTheNextWord();
				});
			});
			
			
			$("#trainingForm").on("submit", function() { /* обработать введённое пользователем слово */
				if (event.preventDefault) event.preventDefault(); /* не переходить на новую страницу (отключить обработчик по умолчанию) */
				var currentInput = document.getElementById('trainingInput').value.toLowerCase(); /* положить в переменную текущий инпут */ 
				if (currentInput == rightAnswer) { /* если верный ответ */
					document.getElementById('trainingText').innerText = "Вы ввели верное слово. Для проигрывания следующего слова нажмите на Play."; /* изменить текст */
					getToTheNextWord() /* перейти к следующему слову */	
				}
				else{ /* если неверный ответ */
					if (audioFinished == false){ /* если слово не проиграно до конца */
						currentLength += 0.050; /* прибавить 50ms */
						document.getElementById('trainingText').innerText = "Вы ввели неверное слово. Для повторного проигрывания слова нажмите на Play."; /* изменить текст */
					};
				};
				document.getElementById('trainingInput').value = "" /* стереть значение инпута */
				$("#trainingButton").click();
				return false;
			});
			
			
			$("#trainingButton").on("click", function(){
				if (event.preventDefault) event.preventDefault(); /* не переходить на новую страницу (отключить обработчик по умолчанию) */
				audio.currentTime = 0.0; /* начать проигрываеть слово с начала */
				audio.play(); /* проиграть слово */
				if(firstRun == true){ /* если проигрывается первое слово */
					document.getElementById('trainingText').innerText = "Введите слово. Если вы не знаете слова, нажмите на Play." /* изменить текст */
				};
				firstRun = false; /* изменить значение на "проигрывается не первое слово" */
				audio.addEventListener("ended", function(){ /* когда аудио заканчивается */
					audioFinished = true; /* аудио закончилось */
						document.getElementById('trainingText').innerText = "Cлово проиграно до конца. Прочитайте инструкцию снова." /* изменить текст */
						document.getElementById('trainingPage').style="display: none"; /* скрыть consentPage */
						document.getElementById('instructionPage').style="display: block"; /* показать instructionPage */
					}
				);
			});
			
			
			$('#inqueryForm').on("submit", function() {
				if (event.preventDefault) event.preventDefault(); /* не переходить на новую страницу (отключить обработчик по умолчанию) */
				/* if(document.forms['inqueryForm']['userName'].required) */
				userData = $('#inqueryForm').serializeArray().reduce(function(obj, item) {
					obj[item.name] = obj[item.name]||item.value; /* username = userData[userName] - не работает */
					return obj;
				}, {});
				document.getElementById('inqueryPage').style="display: none"; /* скрыть inqueryPage */
				document.getElementById('instructionPage').style="display: block"; /* показать instructionPage */
				console.log(userData)
			});
			
			
			$('#consentForm').on("submit", function() {
				if (event.preventDefault) event.preventDefault(); /* не переходить на новую страницу (отключить обработчик по умолчанию) */
				document.getElementById('consentPage').style="display: none"; /* скрыть consentPage */
				document.getElementById('experimentPage').style="display: block"; /* показать experimentPage */
				document.getElementById('text').innerText = "Для проигрывания слова нажмите на Play." /* изменить текст */
				getToTheNextWord();
			});
			
			
			$('#instructionForm').on("submit", function() {
				if (event.preventDefault) event.preventDefault(); /* не переходить на новую страницу (отключить обработчик по умолчанию) */
				document.getElementById('instructionPage').style="display: none"; /* скрыть instructionPage */
				document.getElementById('trainingPage').style="display: block"; /* показать consentPage */
				document.getElementById('trainingText').innerText = "Для проигрывания слова нажмите на Play." /* изменить текст */
				getToTheNextWord();
			});
		});
	</script>
</head>
<body>

	<div id="inqueryPage" > <!-- страница с анкетой -->
	<form id="inqueryForm">
		<div>
			<label for="userNameInput">Имя и фамилия: </label><br> <input id="userNameInput" name="userName" type="text" required><!-- Имя и фамилия -->
		</div>

		<div>
			<label for="ageInput">Возраст (полных лет): </label><br> <input id="userAgeInput" name="userAge" type="number" min="6" max="90" required><!-- Возраст (полных лет) -->
		</div>
		
		<div>
			<label for="userSexRadio">Пол: </label> <!-- radio: Пол: м/ж/другое (укажите) -->
			<div id="userSexRadio">
				<div>
					<input type="radio" name="userSex" value="male" id="sexMale" required>
					<label for="sexMale">мужской</label>
				</div>
				<div>
					<input type="radio" name="userSex" value="female" id="sexFemale" required>
					<label for="sexFemale">женский</label>
				</div>
				<div>
				  <input type="radio" name="userSex" value="" id="sexOther" required>
				  <label for="sexOther">другое (укажите):</label>     
				  <input type="text" name="userSex">
				</div>
			</div>
		</div>

		<div>
			<label for="userEducationRadio">Образование: </label> <!-- radio: Образование: среднее/среднее специальное/неоконченное высшее/высшее/ученая степень -->
			<div id="userEducationRadio">
				<div>
					<input type="radio" name="userEducation" value="school" id="educationSch" required>
					<label for="educationSch">среднее</label>
				</div>
				<div>
					<input type="radio" name="userEducation" value="school special" id="educationScpecSch" required>
					<label for="educationScpecSch">среднее специальное</label>
				</div>
				<div>
				  <input type="radio" name="userEducation" value="higher undergraduate" id="educationHighUnd" required>
				  <label for="educationHighUnd">неоконченное высшее</label>     
				</div>
								<div>
					<input type="radio" name="userEducation" value="graduate" id="educationHighGr" required>
					<label for="educationHighGr">высшее</label>
				</div>
				<div>
				  <input type="radio" name="userEducation" value="degree" id="educationDegree" required>
				  <label for="educationDegree">ученая степень</label>     
				</div>
			</div>
		</div>
		
		<div>
			<label for="yearsOfEducationInput">Длительность образования в годах (например, школа+среднее специальное+высшее - 11+2+5=18 лет): </label><br> 
			<input id="yearsOfEducationInput" name="userYearsOfEducation" type="number" min="1" max="40" required><!-- Длительность образования в годах (например, школа+среднее специальное+высшее - 11+2+5=18 лет) -->
		</div>
		
		<div>
			<label for="professionInput">Область профессиональной деятельности: </label><br> 
			<input id="userProfessionInput" name="userProfession" type="text" required><br> <!-- Область профессиональной деятельности -->
		</div>
		
		<div>
			<label for="languageInput">Родной язык: </label><br> 
			<input id="userLanguageInput" name="userLanguage" type="text" required><!-- Родной язык -->
		</div>
		
		<div>
			<label for="userHandRadio">Ведущая рука: </label> <!-- radio: Ведущая рука: правша/левша/амбидекстер/переученный левша -->
			<div id="userHandRadio">
				<div>
					<input type="radio" name="userHand" value="right" id="handRight" required>
					<label for="handRight">правша</label>
				</div>
				<div>
					<input type="radio" name="userHand" value="left" id="handLeft" required>
					<label for="handLeft">левша</label>
				</div>
				<div>
				  <input type="radio" name="userHand" value="ambi" id="handAmbi" required>
				  <label for="handAmbi">амбидекстер</label>     
				</div>
				<div>
					<input type="radio" name="userHand" value="right to left" id="handRtoL" required>
					<label for="handRtoL">переученный левша</label>
				</div>
			</div>
		</div>
		
		<div>
			<label for="userDisordersRadio">Имеются ли у вас неврологические/психиатрические  расстройства?</label> <!-- radio: Имеются ли у вас неврологические/психиатрические  расстройства?: нет/да(какие) -->
			<div id="userDisordersRadio">
				<div>
					<input type="radio" name="userDisorders" value="no" id="noDisorders" required>
					<label for="noDisorders">нет</label>
				</div>
				<div>
				  <input type="radio" name="userDisorders" value="" id="disorders" required>
				  <label for="disorders">да (укажите какие):</label>     
				  <input type="text" name="userDisorders">
				</div>
			</div>
		</div>
		
		<div>
			<label for="userMedicationRadio">Принимаете ли вы какие медицинские препараты, которые могут повлиять на концентрацию внимания и время реакции?</label> <!-- radio: Принимаете ли вы какие медицинские препараты, которые могут повлиять на концентрацию внимания и время реакции?: нет/да(какие) -->
			<div id="userMedicationRadio">
				<div>
					<input type="radio" name="userMedication" value="no" id="noMedication" required>
					<label for="noMedication">нет</label>
				</div>
				<div>
				  <input type="radio" name="userMedication" value="" id="Medication" required>
				  <label for="Medication">да (укажите какие):</label>     
				  <input type="text" name="userMedication">
				</div>
			</div>
		</div>

		<div>
			<label for="userPerceptionRadio">Есть ли у вас какие-то проблемы со зрением или слухом?:</label> <!-- radio: Есть ли у вас какие-то проблемы со зрением или слухом?: нет/да(какие) -->
			<div id="userPerceptionRadio">
				<div>
					<input type="radio" name="userPerception" value="no" id="noPerceptionDisorder" required>
					<label for="noPerceptionDisorder">нет</label>
				</div>
				<div>
				  <input type="radio" name="userPerception" value="" id="perceptionDisorder" required>
				  <label for="perceptionDisorder">да (укажите какие):</label>     
				  <input type="text" name="userPerception">
				</div>
			</div>
		</div>
		<button type="submit" >Готово</button>
	</form>
</div>

	<div id="instructionPage" style="display: none"> <!-- страница с инструкцией --> <!-- проверить инструкции -->
		Пожалуйста, внимательно прочитайте инструкцию. <br>
		В эксперименте Вам по нажатию на Play будут предъявляться на слух части слов. Если вам кажется что вы знаете проигрываемое слово - вы должны напечатать его на экране. Если не знаете - нажать Play, в этом случае повторно будет проиграна уже бОльшая часть слова. <br> 
		Когда слово проиграно полностью (если до этого вы его не угадали) - вы обязаны вписать ту догадку, которая у вас есть. <br>
		Среди предъявляемых слов могут быть слова во множественном числе и жаргонные слова. Все слова - существительные, одушевленные. Ваша задача - угадать звучащее слово, которое является продолжением для "Там был(-а,-о) ... / Я заметил(а)...". <br>
		Если вы не знаете слова, снова нажмите на Play. После того, как вы угадаете слово, по нажатию на Play, Вам будет предъявлено следующее слово. <br>
		<form id="instructionForm">	
			<button id="instructionCheck" type="submit">Я понял инструкцию</button> <!-- кнопочочка подтверждения понимания инструкции -->
		</form>
	</div>

	<div id="trainingPage" style="display: none"> <!-- страница с экспериментом -->
		<audio id="sample" preload></audio>

		<a id="trainingButton" href="#">Play</a> <!-- кнопка Play -->
		<div id="trainingText"> <!-- текстовый блок -->
			Для проигривания слова нажмите на Play.
		</div>

		<form id="trainingForm"> <!-- Форма с инпутом для глаголов-->
			<div id="trainingInputDiv"> <!-- невидимый блок с инпутом и кнопкой go -->
				<input id="trainingInput" type="text" name="in" value=""/>
				<button type="submit">Go</button>
			</div>
		</form>
	</div>

	<div id="consentPage" style="display: none"> <!-- страница с формой информированного согласия -->
		<div id="consentText">
			Тренировка окончена. Пожалуйста, заполните форму согласия на участие в эксперименте: <br>
		
			Я заявляю о добровольном участии в лингвистическом исследовании «Исследование скорости узнавания предъявляемых на слух слов», проводимом лабораторией нейролингвистики НИУ «Высшая школа экономики». Я согласен с тем, что данные, полученные от меня в ходе исследования (личные данные, результаты теста), могут быть опубликованы и использованы в научных целях при условии, что моё имя останется в тайне. <br>

			Я проинформирован о процедуре исследования, которая заключается в выполнении речевого задания на компьютере (узнавание слов, предъявленных на слух по частям). Я также проинформирован, что могу прекратить участие в исследовании в любое время. <br>

			Я также подтверждаю, что на момент исследования: <br>

			1. Не имею нескорректированных проблем со слухом и зрением; <br>
			2. Не принимаю медицинские препараты, влияющие на концентрацию внимания и время реакции, или указал название принимаемых мною препаратов; <br>
			3. Не нахожусь под воздействием алкоголя и иных психотропных веществ. <br>
		</div> 
		<form id="consentForm">
			<button type="submit" >Согласен</button> <!-- кнопочка согласия -->
		</form>
	</div> <!-- прилепить переход на след. страницу -->

	<div id="experimentPage" style="display: none"> <!-- страница с экспериментом -->
		<audio id="sample" preload></audio>

		<a id="playButton" href="#">Play</a> <!-- кнопка Play -->
		<div id="text"> <!-- текстовый блок -->
			Для проигривания слова нажмите на Play.
		</div>

		<form id="verbForm"> <!-- Форма с инпутом для глаголов-->
			<div id="wordInputDiv"> <!-- невидимый блок с инпутом и кнопкой go -->
				<input id="input" type="text" name="in" value=""/>
				<button type="submit" >Go</button>
			</div>
		</form>
	</div>
</body>
</html>